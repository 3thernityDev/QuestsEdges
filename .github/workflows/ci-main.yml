name: CI/CD - main (Release & Deploy)

on:
    push:
        branches: [main]

permissions:
    contents: write

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

env:
    NODE_OPTIONS: "--max_old_space_size=2048"

jobs:
    test:
        name: Tests & Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Generate Prisma Client
              run: npx prisma generate
              env:
                  DATABASE_URL: "file:./dev.db"

            - name: Lint
              run: npm run lint

            - name: Test
              run: npm test

    build:
        name: Build & Archive
        runs-on: ubuntu-latest
        needs: test
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Generate Prisma Client
              run: npx prisma generate
              env:
                  DATABASE_URL: "file:./dev.db"

            - name: Build
              run: npm run build

            - name: Verify build folder
              run: |
                  if [ -d "dist" ]; then
                    echo "Build OK"
                    ls -la dist | head -n 20
                  else
                    echo "No dist directory"
                    exit 1
                  fi

            - name: Prepare artifact contents
              shell: bash
              run: |
                  mkdir -p QuestsEdges
                  cat > QuestsEdges/.env << 'EOF'
                  ${{ secrets.PROD_ENV_FILE }}
                  EOF
                  sed -i '/^DATABASE_URL=/d' QuestsEdges/.env
                  echo 'DATABASE_URL="file:./dev.db"' >> QuestsEdges/.env
                  chmod 600 QuestsEdges/.env

            - name: Archive build
              run: |
                  ARCHIVE="questsedges-api-${{ github.sha }}.tar.gz"
                  tar -czf "$ARCHIVE" dist/ package.json package-lock.json QuestsEdges/.env compose.prod.yml prisma/
                  echo "archive=$ARCHIVE" >> $GITHUB_OUTPUT

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: build-archive
                  path: questsedges-api-${{ github.sha }}.tar.gz
                  retention-days: 7

    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: build
        outputs:
            tag: ${{ steps.version.outputs.tag }}
            version: ${{ steps.version.outputs.version }}
        steps:
            - name: Checkout (full history)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Generate Prisma Client (release)
              run: npx prisma generate
              env:
                  DATABASE_URL: "file:./dev.db"

            - name: Get version & tag
              id: version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  COMMIT_SHORT=$(git rev-parse --short HEAD)
                  TAG="v${VERSION}-${COMMIT_SHORT}"
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "tag=${TAG}" >> $GITHUB_OUTPUT
                  echo "Tag to create: ${TAG}"

            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: build-archive
                  path: .

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.tag }}
                  body: |
                      Release automatique pour ${{ github.ref }}
                      Version: ${{ steps.version.outputs.version }}
                      Commit: ${{ github.sha }}
                  files: questsedges-api-${{ github.sha }}.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    deploy:
        name: Deploy to VPS via Ansible
        runs-on: ubuntu-latest
        needs: release
        environment: production
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: build-archive
                  path: .

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Ansible
              run: pip install --upgrade ansible

            - name: Setup SSH key (private, not printed)
              run: |
                  mkdir -p ~/.ssh
                  # Utilisation de echo pour garantir le format correct et le saut de ligne final
                  echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -p "${{ secrets.VPS_SSH_PORT }}" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

            - name: Test SSH connection
              run: ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p "${{ secrets.VPS_SSH_PORT }}" "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "echo Connexion SSH OK"

            - name: Run Ansible Playbook
              run: |
                  ARCHIVE=$(ls questsedges-api-*.tar.gz | head -n1)
                  ansible-playbook ansible/deploy.yml \
                    -i "${{ secrets.VPS_HOST }}," \
                    -u "${{ secrets.VPS_USER }}" \
                    --private-key ~/.ssh/id_rsa \
                    -e "archive_name=${ARCHIVE}" \
                    -e "ansible_port=${{ secrets.VPS_SSH_PORT }}" \
                    -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no -p ${{ secrets.VPS_SSH_PORT }}'"
              env:
                  ANSIBLE_HOST_KEY_CHECKING: "false"
                  PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
