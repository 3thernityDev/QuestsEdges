---
- name: Deploy QuestsEdges API
  hosts: all
  vars:
      app_name: questsedges-api
      app_dir: /home/srvPod/QuestsEdges
      container_name: questsedges_api

  tasks:

      - name: Purger les anciens services (sans toucher aux volumes de donnees)
        ansible.builtin.command: podman-compose -f compose.prod.yml down
        args:
            chdir: "{{ app_dir }}"
        register: compose_down
        changed_when: compose_down.rc == 0
        failed_when: compose_down.rc != 0 and 'no project' not in compose_down.stderr
        become_user: srvPod

      - name: Supprimer le volume api_node_modules pour un clean slate
        ansible.builtin.command: podman volume rm questsedges-api_api_node_modules
        register: remove_volume
        failed_when: remove_volume.rc != 0 and 'not found' not in remove_volume.stderr
        changed_when: remove_volume.rc == 0
        become_user: srvPod

      - name: Demarrer ou Mettre a jour les services avec podman-compose
        ansible.builtin.command: podman-compose -f compose.prod.yml up -d
        args:
            chdir: "{{ app_dir }}"
        register: compose_up
        changed_when: compose_up.rc != 0 or 'Recreating' in compose_up.stdout
        become_user: srvPod

      - name: Nettoyer le cache NPM
        ansible.builtin.command: podman exec --user 0 {{ container_name }} npm cache clean --force
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Installer les dependances dans le conteneur
        ansible.builtin.command: podman exec --user 0 {{ container_name }} npm install --omit=dev
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Generer le client Prisma
        ansible.builtin.command: podman exec --user 0 {{ container_name }} npx prisma generate
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Appliquer les migrations de base de donnees
        ansible.builtin.command: podman exec --user 0 {{ container_name }} npx prisma migrate deploy
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Rebuild TypeScript
        ansible.builtin.command: podman exec --user 0 {{ container_name }} npm run build
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Lancer l'API en production
        ansible.builtin.command: podman exec -d {{ container_name }} node dist/index.js
        become_user: srvPod

      - name: Attendre que l'API soit prete
        ansible.builtin.wait_for:
            port: 3000
            host: localhost
            delay: 5
            timeout: 60

      - name: Verifier le health check
        ansible.builtin.uri:
            url: http://localhost:3000/health
            method: GET
            status_code: 200
        register: health_check
        retries: 3
        delay: 5

      - name: Afficher le resultat du health check
        ansible.builtin.debug:
            msg: "API deployee avec succes - Status: {{ health_check.json.status }}"
