---
- name: Deploy QuestsEdges API
  hosts: all
  vars:
      app_name: questsedges-api
      app_dir: /home/srvPod/QuestsEdges
      container_name: questsedges_api

  tasks:
      - name: Afficher la version deployee
        debug:
            msg: "Deploiement de la version {{ release_tag }}"

      - name: Creer le repertoire d'application
        ansible.builtin.file:
            path: "{{ app_dir }}"
            state: directory
            owner: srvPod
            mode: "0755"
        become_user: root

      - name: Copier l'archive de build sur le VPS
        ansible.builtin.copy:
            src: "{{ lookup('env', 'GITHUB_WORKSPACE') }}/{{ archive_name }}"
            dest: "{{ app_dir }}/{{ archive_name }}"
            owner: srvPod
            mode: "0644"
        become_user: srvPod

      - name: Extraire l'archive dans le repertoire d'application
        ansible.builtin.unarchive:
            src: "{{ app_dir }}/{{ archive_name }}"
            dest: "{{ app_dir }}"
            remote_src: yes
            owner: srvPod
        become_user: srvPod

      - name: Deplacer le .env au bon endroit
        ansible.builtin.command: mv "{{ app_dir }}/QuestsEdges/.env" "{{ app_dir }}/.env"
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Supprimer le dossier QuestsEdges cree par l'archive
        ansible.builtin.file:
            path: "{{ app_dir }}/QuestsEdges"
            state: absent
        become_user: srvPod

      - name: Verifier si le fichier .env existe
        ansible.builtin.stat:
            path: "{{ app_dir }}/.env"
        register: env_file

      - name: FAIL si .env manquant
        ansible.builtin.fail:
            msg: "Le fichier .env n'existe pas dans {{ app_dir }}. Veuillez le creer."
        when: not env_file.stat.exists

      - name: Purger les anciens services (sans toucher aux volumes de donnees)
        ansible.builtin.command: podman-compose -f compose.prod.yml down
        args:
            chdir: "{{ app_dir }}"
        register: compose_down
        changed_when: compose_down.rc == 0
        failed_when: compose_down.rc != 0 and 'no project' not in compose_down.stderr
        become_user: srvPod

      - name: Demarrer ou Mettre a jour les services avec podman-compose
        ansible.builtin.command: podman-compose -f compose.prod.yml up -d
        args:
            chdir: "{{ app_dir }}"
        register: compose_up
        changed_when: compose_up.rc != 0 or 'Recreating' in compose_up.stdout
        become_user: srvPod

      - name: Installer les dependances dans le conteneur
        ansible.builtin.command: podman exec {{ container_name }} npm i --omit=dev
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Generer le client Prisma
        ansible.builtin.command: podman exec {{ container_name }} npx prisma generate
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Appliquer les migrations de base de donnees
        ansible.builtin.command: podman exec {{ container_name }} npx prisma migrate deploy
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Rebuild TypeScript
        ansible.builtin.command: podman exec {{ container_name }} npm run build
        args:
            chdir: "{{ app_dir }}"
        become_user: srvPod

      - name: Lancer l'API en production
        ansible.builtin.command: podman exec -d {{ container_name }} node dist/index.js
        become_user: srvPod

      - name: Attendre que l'API soit prete
        ansible.builtin.wait_for:
            port: 3000
            host: localhost
            delay: 5
            timeout: 60

      - name: Verifier le health check
        ansible.builtin.uri:
            url: http://localhost:3000/health
            method: GET
            status_code: 200
        register: health_check
        retries: 3
        delay: 5

      - name: Afficher le resultat du health check
        ansible.builtin.debug:
            msg: "API deployee avec succes - Status: {{ health_check.json.status }}"
